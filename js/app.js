var app=angular.module("ellis",[]);app.controller("AppController",["$scope","$http",function(a,b){a.start=function(){b.get("./data/evictions.json").success(function(c){a.evictions=c,angular.forEach(a.evictions,function(a){a.date=new Date(a.year,0,1)});var d=d3.min(a.evictions,function(a){return a.date});b.get("./data/prices.json").success(function(b){a.price_data={},angular.forEach(b,function(b,c){a.price_data[c]=[],angular.forEach(b,function(b){b.date=new Date(1e3*b.date),b.date>d&&a.price_data[c].push(b)})}),a.evictions_series_shown={ellis:!0},a.price_series_shown="all"})})},a.seriesInfo={ellis:{name:"Ellis Act Evictions"},nofault:{name:"All No-Fault Evictions"},forcause:{name:"For Cause Evictions"}},a.priceInfo={all:{name:"All homes"},single:{name:"All single-family homes"},condo:{name:"All condos/co-ops"},"1bed":{name:"1 bedroom"},"2bed":{name:"2 bedrooms"},"3bed":{name:"3 bedrooms"}},a.$watch("evictions_series_shown",function(){a.showGraph()},!0),a.$watch("price_series_shown",function(){a.showGraph()},!0),a.start(),a.getMaxValueForSeriesShown=function(b){return d3.max(a.evictions,function(a){var c;return angular.forEach(b,function(b){var d=a[b];void 0!==d&&(c=void 0===c?d:Math.max(c,d))}),c})};var c={};a.showGraph=function(){if(void 0!==a.evictions){var b=[];angular.forEach(a.evictions_series_shown,function(a,c){a===!0&&b.push(c)});var d=!d3.selectAll("body.embeddable").empty();if(d)var e=420,f=300;else var e=700,f=420;var g=20,h=60,i=d3.time.scale().domain([d3.min(a.evictions,function(a){return a.date}),d3.max(a.evictions,function(a){return a.date})]).rangeRound([h,e-h]),j=d3.scale.linear().domain([0,a.getMaxValueForSeriesShown(b)]).range([f-2*g,g]);d3.svg.axis().scale(i).ticks(d3.time.year,1);var k=d3.svg.axis().scale(j).orient("left").tickSize(10),l=(e-2*h)/20;if(!a.isSetUp){graph_container=d3.select("#graph"),graph_container.html("");var m=graph_container.append("svg:svg").attr("width",e+2*h).attr("height",f+2*g);m.append("g").attr("class","year_labels"),m.append("svg:path").attr("class","data-line");var n=m.append("g").attr("class","all_bars");n.selectAll("g").data(a.evictions).enter().append("g").attr("class","year_group"),graph_container.append("div").attr("id","tooltip"),m.append("line").attr("class","x-line").style("stroke","black").style("stroke-width","1").attr("x1",h).attr("x2",e-h).attr("y1",j(0)+g).attr("y2",j(0)+g),m.append("g").attr("class","y-axis").attr("transform","translate("+h+","+g+")"),m.append("g").attr("class","y-axis-right").attr("transform","translate("+(e-h/2)+","+g+")"),m.append("text").attr("class","y-label-right").text("Median Home Price").attr("text-anchor","middle").attr("transform","translate("+(e+h/2)+", "+(f/2-g/2)+"), rotate(90)"),m.append("text").attr("class","y-label").text("Evictions").attr("text-anchor","middle").attr("transform","translate(12,"+(f/2-g/2)+"), rotate(-90)"),a.isSetUp=!0}var m=d3.select("#graph svg");m.selectAll("g.x-axis");var o=m.selectAll("g.y-axis"),p=m.selectAll("g.y-axis-right");m.selectAll("text.y-label-right");var n=d3.selectAll("g.all_bars"),q=d3.selectAll("g.year_labels");m.selectAll("line.x-line");var r=n.selectAll("g.year_group"),s=d3.select("div#tooltip"),t=d3.selectAll(".data-line"),u=q.selectAll("g").data(a.evictions).enter().append("g").attr("class","year_label");if(u.append("rect").attr("x",function(a){return i(a.date)}).attr("y",0).attr("fill",function(a,b){return b%2?"rgba(240,240,240,1)":"#fff"}).attr("width",l).attr("height",f-g),u.append("text").text(function(a){return d3.time.format("'%y")(a.date)}).attr("x",function(a){return i(a.date)+l/2}).attr("y",g+2).attr("text-anchor","middle"),d3.selectAll(".y-label-right").style("display","inherit"),"none"!==a.price_series_shown){var v=function(a){return a.price},w=a.price_data[a.price_series_shown],x=d3.scale.linear().domain([d3.min(w,v),d3.max(w,v)]).range([f-2*g,g]),y=d3.svg.axis().scale(x).orient("right").ticks(10).tickFormat(function(a){return"$"+a/1e3+"K"});p.style("display","inherit"),p.transition().call(y);var z=d3.svg.line().interpolate("cardinal").x(function(a){return i(a.date)}).y(function(a){return x(a.price)});t.transition().style("display","inherit").attr("d",z(w)).attr("stroke","blue").attr("fill","none")}else t.style("display","none"),p.style("display","none"),d3.selectAll(".y-label-right").style("display","none");var A=l/b.length;angular.forEach(a.evictions_series_shown,function(d,e){if(d===!1)d3.selectAll("rect."+e).remove(),c[e]=void 0;else{var f=c[e];void 0===f&&(f=r.append("rect").attr("class",e),c[e]=f),f.on("mousemove",function(b){s.style("visibility","visible"),s.style("top",event.clientY+"px"),s.style("left",event.clientX+6+"px"),s.html("<strong>"+a.seriesInfo[e].name+" in "+b.year+':</strong><br/><span class="big-num">'+d3.format(",")(Math.abs(b[e]))+"</span>")}).on("mouseout",function(){s.style("visibility","hidden")}).transition().attr("height",function(a){return Math.abs(j(a[e]?a[e]:0)-j(0))}).attr("x",function(a){return i(a.date)+A*b.indexOf(e)}).attr("y",function(a){var b=Math.abs(j(a[e])-j(0));return j(0)-b+g}).attr("width",function(){return A-1})}}),o.transition().call(k)}}}]);