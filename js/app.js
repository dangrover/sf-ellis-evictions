var app=angular.module("ellis",[]);app.controller("AppController",["$scope","$http",function(a,b){a.start=function(){b.get("./data/ellis.json").success(function(c){a.ellis_evictions=c,b.get("./data/inventory.json").success(function(b){a.housing_inventory=b,a.all_data=[];var c={};angular.forEach(a.ellis_evictions,function(b,d){var e=parseInt(d),f={year:e,date:new Date(e,0,1),withdrawn:0,"withdrawn-petitions":0};angular.forEach(b,function(a){f.withdrawn+=a[1],f["withdrawn-petitions"]+=a[0]}),a.all_data.push(f),c[e]=f}),angular.forEach(a.housing_inventory,function(a){void 0!==c[a.year]&&angular.forEach(a,function(b,d){"year"!==d&&(c[a.year][d]=b)})}),angular.forEach(a.all_data,function(a){a.withdrawn*=-1,a.demolished*=-1}),a.housing_series_shown.withdrawn=!0})})},a.seriesInfo={withdrawn:{},authorized:{},constructed:{},demolished:{},altered:{}},a.housing_series_shown={},a.$watch("housing_series_shown",function(b){console.log("series=%o",b),a.showGraph()},!0),a.start(),a.showGraph=function(){if(void 0!==a.all_data){var b=[];angular.forEach(a.housing_series_shown,function(a,c){a===!0&&b.push(c)}),console.log("we are showing the series: %o",b);var c=800,d=450,e=30,f=40;if(a.isSetUp)var g=d3.select("#graph svg");else{graph_container=d3.select("#graph"),graph_container.html("");var g=graph_container.append("svg:svg").attr("width",c).attr("height",d+100);g.append("g").attr("class","all_bars"),a.isSetUp=!0}var h=d3.time.scale().domain([d3.min(a.all_data,function(a){return a.date}),d3.max(a.all_data,function(a){return a.date})]).rangeRound([f,c-2*f]),i=d3.scale.linear().domain([-3e3,6e3]).range([d-2*e,e]),j=d3.svg.axis().scale(h).orient("bottom").ticks(d3.time.year,1).tickFormat(d3.time.format("'%y")),k=d3.svg.axis().scale(i).orient("left").tickSize(10),l=(c-2*f)/19,m=Math.floor(l/b.length),n=d3.selectAll("g.all_bars");n.selectAll("g.year_group").remove();var o=n.selectAll("g").data(a.all_data).enter().append("g").attr("class","year_group");angular.forEach(b,function(a,b){o.append("rect").attr("class",a).attr("data-year",function(a){return a.year}).attr("data-val",function(b){return b[a]}).transition().attr("height",function(b){return Math.abs(i(b[a])-i(0))}).attr("x",function(a){return h(a.date)+m*b}).attr("y",function(b){var c=b[a];if(console.log("val=%o",c),0>=c)return i(0)+e;i(c);var d=Math.abs(i(c)-i(0));return i(0)+e-d}).attr("width",function(){return m})}),console.log("in_year = %o",o),g.selectAll("g.x-axis").remove(),g.append("g").attr("class","x-axis").attr("transform","translate(0, "+(e+i(0))+")").call(j).selectAll("text").style("text-anchor","middle").attr("dy",""+-1*(d/2+30)+"px").attr("dx","18px").call(j),g.selectAll("g.y-axis").remove(),g.append("g").attr("class","y-axis").attr("transform","translate("+f+",0)").call(k)}}}]);